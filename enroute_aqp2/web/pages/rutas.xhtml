<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/sidebarTemplate.xhtml">

  <ui:param name="active" value="rutas" />
  <ui:define name="pageTitle">#{msg['page.routes.title']}</ui:define>

  <ui:define name="content">
    <!-- Main layout converted from rutas.jsp -->
    <div class="container-fluid p-0 h-100">
                    <!--Mobile Header-->
            <div class="d-lg-none bg-white shadow-sm p-3 border-bottom mb-3">
                <h2 class="mb-0 fw-bold text-dark">#{msg['page.routes.title']}</h2>
            </div>
      <div class="row g-0 h-100">
        <!-- Left Panel - Search and Routes -->
        <div class="col-12 col-lg-5 bg-white border-end">
          <div class="p-4 h-100 d-flex flex-column">
            <!-- Page Title (Desktop only) -->
            <div class="d-none d-lg-block mb-4">
              <h1 class="fw-bold text-dark mb-0">#{msg['page.routes.title']}</h1>
            </div>

            <!-- Available Routes (paginated) -->
            <div class="flex-grow-1 d-flex flex-column">
              <h:form style="flex:1; display:flex; flex-direction:column;">
                <p:dataTable value="#{rutasBean.lineas}" var="ln" paginator="true" rows="9" styleClass="table-sm" style="flex:1;"
                             emptyMessage="#{msg['table.routes.empty']}" widgetVar="rutasTbl">                  
                  <p:column headerText="#{msg['table.name']}" sortBy="#{ln.nombre}" filterBy="#{ln.nombre}" filterMatchMode="contains">
                    <h:outputText value="#{ln.nombre}" />
                  </p:column>
                  <p:column headerText="#{msg['table.description']}" filterBy="#{ln.descripcion}" filterMatchMode="contains">
                    <h:outputText value="#{ln.descripcion}" />
                  </p:column>
                  <p:column headerText="AcciÃ³n" style="width:110px; text-align:center;">
                    <a href="#" onclick="mostrarRuta('#{ln.id}');return false;" class="btn btn-sm btn-outline-primary">#{msg['button.view']}</a>
                  </p:column>
                </p:dataTable>
              </h:form>
            </div>
          </div>
        </div>

        <!-- Right Panel - Map -->
        <div class="col-12 col-lg-7 position-relative">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body p-0 h-100">
              <div id="routesLeafletMap" style="width:100%; height:100%; min-height:600px;"></div>
            </div>
          </div>

          <!-- Map Controls -->
          <div class="position-absolute top-0 end-0 m-3">
            <div class="btn-group-vertical shadow-sm">
              <button class="btn btn-white border" onclick="zoomIn()"><i class="bi bi-plus-lg"></i></button>
              <button class="btn btn-white border" onclick="zoomOut()"><i class="bi bi-dash-lg"></i></button>
            </div>
          </div>

          <!-- Map Legend -->
          <div class="position-absolute bottom-0 start-0 m-3">
            <div class="bg-white rounded-3 shadow-sm p-3" style="min-width: 200px;">
              <h6 class="fw-bold mb-2">#{msg['legend.title']}</h6>
              <div class="d-flex align-items-center mb-2"><div class="bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div><small>#{msg['legend.activeRoutes']}</small></div>
              <div class="d-flex align-items-center mb-2"><div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div><small>#{msg['legend.limitedRoutes']}</small></div>
              <div class="d-flex align-items-center"><div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div><small>#{msg['legend.outOfService']}</small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Expose routes JSON from bean to JS
      window.ROUTES = <h:outputText value="#{rutasBean.routesJson}" escape="false"/>;
      // attach click handlers to route cards
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.route-card[data-linea]')
          .forEach(function(el){
            el.addEventListener('click', function(){
              var id = parseInt(this.getAttribute('data-linea'));
              if (!isNaN(id)) mostrarRuta(id);
            });
          });
      });
      function searchRoutes() {
        const searchTerm = document.getElementById('routeSearch').value;
        if (searchTerm.trim()) alert('#{msg['alerts.searching']}: ' + searchTerm);
        else alert('#{msg['alerts.enterOriginDest']}');
      }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="#{facesContext.externalContext.requestContextPath}/js/rutas.js"></script>
    <style>
      .bg-light { background-color: #f8f9fa !important; }
    </style>
  </ui:define>

</ui:composition>
