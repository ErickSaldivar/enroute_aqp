<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/templates/sidebarTemplate.xhtml">

  <ui:param name="active" value="rutas" />
  <ui:define name="pageTitle">Rutas Disponibles - Enroute AQP</ui:define>

  <ui:define name="content">
    <!-- Main layout converted from rutas.jsp -->
    <div class="container-fluid p-0 h-100">
                    <!--Mobile Header-->
            <div class="d-lg-none bg-white shadow-sm p-3 border-bottom mb-3">
                <h2 class="mb-0 fw-bold text-dark">Rutas Disponibles</h2>
            </div>
      <div class="row g-0 h-100">
        <!-- Left Panel - Search and Routes -->
        <div class="col-12 col-lg-5 bg-white border-end">
          <div class="p-4 h-100 d-flex flex-column">
            <!-- Page Title (Desktop only) -->
            <div class="d-none d-lg-block mb-4">
              <h1 class="fw-bold text-dark mb-0">Rutas Disponibles</h1>
            </div>

            <!-- Search Box -->
            <div class="mb-4">
              <div class="position-relative">
                <input type="text" class="form-control form-control-lg bg-light border-0 ps-5" placeholder="Ingresa tu origen y destino" id="routeSearch" />
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted fs-5"></i>
              </div>
            </div>

            <!-- Available Routes (dynamic) -->
            <div class="flex-grow-1">
              <h4 class="fw-bold text-dark mb-3">Rutas Encontradas</h4>
              <ui:repeat value="#{rutasBean.lineas}" var="ln">
       <div class="border rounded-3 p-3 mb-3 bg-light route-card" style="cursor: pointer;"
         data-linea="#{ln.id}">
                  <div class="d-flex align-items-center">
                    <div class="rounded-2 p-2 me-3" style="background-color: #DD6B20;"><i class="bi bi-bus-front text-white fs-5"></i></div>
                    <div class="flex-grow-1">
                      <h5 class="mb-1 fw-bold text-warning">#{ln.nombre}</h5>
                      <p class="mb-0 text-muted small">#{ln.descripcion}</p>
                    </div>
                    <div class="text-end"><span class="badge bg-success">Activa</span></div>
                  </div>
                </div>
              </ui:repeat>
            </div>

            <!-- Search Button -->
            <div class="mt-4">
              <button class="btn w-100 py-3 fw-bold text-white" style="background-color: #DD6B20;" onclick="searchRoutes()">
                <i class="bi bi-search me-2"></i>
                Buscar Ruta
              </button>
            </div>
          </div>
        </div>

        <!-- Right Panel - Map -->
        <div class="col-12 col-lg-7 position-relative">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body p-0 h-100">
              <div id="routesLeafletMap" style="width:100%; height:100%; min-height:600px;"></div>
            </div>
          </div>

          <!-- Map Controls -->
          <div class="position-absolute top-0 end-0 m-3">
            <div class="btn-group-vertical shadow-sm">
              <button class="btn btn-white border" onclick="zoomIn()"><i class="bi bi-plus-lg"></i></button>
              <button class="btn btn-white border" onclick="zoomOut()"><i class="bi bi-dash-lg"></i></button>
            </div>
          </div>

          <!-- Map Legend -->
          <div class="position-absolute bottom-0 start-0 m-3">
            <div class="bg-white rounded-3 shadow-sm p-3" style="min-width: 200px;">
              <h6 class="fw-bold mb-2">Leyenda</h6>
              <div class="d-flex align-items-center mb-2"><div class="bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div><small>Rutas activas</small></div>
              <div class="d-flex align-items-center mb-2"><div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div><small>Rutas limitadas</small></div>
              <div class="d-flex align-items-center"><div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div><small>Fuera de servicio</small></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Expose routes JSON from bean to JS
      window.ROUTES = <h:outputText value="#{rutasBean.routesJson}" escape="false"/>;
      // attach click handlers to route cards
      document.addEventListener('DOMContentLoaded', function(){
        document.querySelectorAll('.route-card[data-linea]')
          .forEach(function(el){
            el.addEventListener('click', function(){
              var id = parseInt(this.getAttribute('data-linea'));
              if (!isNaN(id)) mostrarRuta(id);
            });
          });
      });
      function searchRoutes() {
        const searchTerm = document.getElementById('routeSearch').value;
        if (searchTerm.trim()) alert('Buscando rutas para: ' + searchTerm);
        else alert('Por favor, ingresa un origen y destino');
      }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="#{facesContext.externalContext.requestContextPath}/js/rutas.js"></script>
    <style>
      .bg-light { background-color: #f8f9fa !important; }
    </style>
  </ui:define>

</ui:composition>
