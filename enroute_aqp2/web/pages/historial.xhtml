<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/templates/sidebarTemplate.xhtml">

  <ui:param name="active" value="historial" />
  <ui:define name="pageTitle">#{msg['page.history.title']}</ui:define>

  <ui:define name="content">
    <div class="container-fluid px-0">
      <!-- Mobile Header -->
      <div class="d-lg-none bg-white shadow-sm p-3 border-bottom mb-3">
        <h2 class="mb-0 fw-bold text-dark">#{msg['page.history.title']}</h2>
      </div>

      <!-- Desktop Title -->
      <div class="d-none d-lg-block mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="fw-bold text-dark mb-0">#{msg['page.history.title']}</h1>
        </div>
      </div>

      <!-- History Content -->
      <div class="row g-4">
        <ui:fragment rendered="#{empty historialBean.historialAgrupado}">
          <div class="col-12">
            <p class="text-center text-muted">#{msg['page.history.empty']}</p>
          </div>
        </ui:fragment>
        
        <!-- Iterar sobre los grupos de historial (Hoy, Ayer, fechas especÃ­ficas) -->
        <ui:repeat value="#{historialBean.historialAgrupado.entrySet().toArray()}" var="grupo">
          <div class="col-12">
            <div class="bg-white rounded-3 shadow-sm p-4">
              <h3 class="fw-bold text-dark mb-4">#{grupo.key}</h3>

              <!-- Iterar sobre los viajes de este grupo -->
              <ui:repeat value="#{grupo.value}" var="viaje" varStatus="status">
                <div class="border rounded-3 p-3 bg-light" style="margin-bottom: #{status.last ? '0' : '12'}px;">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center flex-grow-1">
                      <div class="rounded-2 p-2 me-3" style="background-color: #DD6B20;">
                        <i class="bi bi-bus-front text-white fs-5"></i>
                      </div>
                      <div class="flex-grow-1">
                        <h5 class="mb-1 fw-bold text-dark">#{viaje.nombreLinea}</h5>
                        <p class="mb-0 text-muted small">
                          #{msg['page.history.origin']}: #{viaje.paraderoSubida}, #{msg['page.history.destination']}: #{viaje.paraderoBajada}
                        </p>
                      </div>
                    </div>
                    <div class="text-end">
                      <small class="text-muted">#{historialBean.formatearHora(viaje.fechaViaje)}</small>
                    </div>
                  </div>
                </div>
              </ui:repeat>
            </div>
          </div>
        </ui:repeat>

        <!-- Statistics -->
        <div class="col-12">
          <div class="bg-white rounded-3 shadow-sm p-4">
            <h4 class="fw-bold text-dark mb-4">#{msg['page.history.stats.title']}</h4>
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <i class="bi bi-bus-front fs-2 mb-2 d-block" style="color: #DD6B20;"></i>
                  <h5 class="fw-bold text-dark mb-1">#{historialBean.totalViajes}</h5>
                  <small class="text-muted">#{msg['page.history.routesUsed']}</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <i class="bi bi-clock fs-2 text-info mb-2 d-block"></i>
                  <h5 class="fw-bold text-dark mb-1">#{historialBean.totalHoras}h</h5>
                  <small class="text-muted">#{msg['page.history.totalTime']}</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <i class="bi bi-currency-dollar fs-2 text-success mb-2 d-block"></i>
                  <h5 class="fw-bold text-dark mb-1">
                    <h:outputText value="S/. #{historialBean.gastoTotal}">
                      <f:convertNumber type="number" minFractionDigits="2" maxFractionDigits="2" 
                                       xmlns:f="http://xmlns.jcp.org/jsf/core"/>
                    </h:outputText>
                  </h5>
                  <small class="text-muted">#{msg['page.history.estimatedSpending']}</small>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="text-center p-3 bg-light rounded-3">
                  <i class="bi bi-geo-alt fs-2 text-danger mb-2 d-block"></i>
                  <h5 class="fw-bold text-dark mb-1">#{historialBean.destinosUnicos}</h5>
                  <small class="text-muted">#{msg['page.history.uniqueDestinations']}</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <h:form>
          <div class="col-12">
            <div class="bg-white rounded-3 shadow-sm p-4">
              <h4 class="fw-bold text-dark mb-3">#{msg['page.history.quickActions.title']}</h4>
              <div class="row g-3">
                
                <div class="col-6 col-md-3">
                  <h:commandButton value="#{msg['button.clearHistory']}" styleClass="btn btn-outline-danger w-100 py-3 rounded-3" 
                                   action="#{historialBean.limpiarHistorial}"
                                   onclick="return confirm('#{msg['dialog.confirm.clearHistory']}');">
                    <f:facet name="icon" xmlns:f="http://xmlns.jcp.org/jsf/core">
                      <i class="bi bi-trash fs-4"></i>
                    </f:facet>
                  </h:commandButton>
                </div>
              </div>
            </div>
          </div>
        </h:form>
      </div>
    </div>

    <style>
      .bg-light { background-color: #f8f9fa !important; }
    </style>
  </ui:define>

</ui:composition>
