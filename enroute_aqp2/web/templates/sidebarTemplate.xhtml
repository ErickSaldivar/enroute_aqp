<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
  <h:head>
    <title><ui:insert name="pageTitle">Enroute AQP</ui:insert></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800;display=swap" rel="stylesheet" />
    <style>
      :root{
        --sidebar-bg: #1f2937; /* slate-800 */
        --sidebar-text: #e5e7eb; /* gray-200 */
        --sidebar-muted: #9ca3af; /* gray-400 */
        --brand-accent: #f59e0b; /* amber-500 */
        --page-bg: #f5efe6; /* warm light */
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
      }
      html, body { height:100%; }
      body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--page-bg); margin:0; }
      /* Fixed-width sidebar so active state doesn't change layout */
      .layout-root { height:100vh; }
      .sidebar { width: 260px; min-width: 260px; max-width: 260px; flex: 0 0 260px; background: var(--sidebar-bg); color: var(--sidebar-text); overflow-y:auto; }
      .sidebar .brand-title { line-height: 1; }
      /* Ensure links occupy full width and keep consistent box sizing */
      .sidebar .nav-link { color: var(--sidebar-text); border-radius: 10px; display: flex; align-items: center; width: 100%; box-sizing: border-box; padding-left: .75rem; padding-right: .75rem; }
      .sidebar .nav-link .bi { width: 22px; text-align: center; margin-right: .75rem; flex: 0 0 22px; }
      /* Prevent active class from changing link size — only change background and color */
      .sidebar .nav-link.active { background: var(--brand-accent); color: #fff; }
      .sidebar .nav-link:hover { background: rgba(255,255,255,.06); color: #fff; }
      .sidebar .nav-link.active { background: var(--brand-accent); color: #fff; }
      .sidebar .section-title { color: var(--sidebar-muted); font-size: .9rem; letter-spacing: .02em; }
      .user-mini { color: var(--sidebar-text); }
      .user-avatar { width: 40px; height: 40px; background: var(--brand-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; color: white; text-transform: uppercase; flex-shrink: 0; }
      .user-avatar i { font-size: 1.3rem; }
      .language-dropdown .dropdown-toggle { color: var(--sidebar-text); border-color: rgba(255,255,255,.2); }
      .language-dropdown .dropdown-toggle:hover { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.3); }
      .language-dropdown .dropdown-menu { background: var(--sidebar-bg); border-color: rgba(255,255,255,.2); }
      .language-dropdown .dropdown-item { color: var(--sidebar-text); }
      .language-dropdown .dropdown-item:hover { background: rgba(255,255,255,.1); color: #fff; }
      .language-dropdown .dropdown-item.active { background: var(--brand-accent); color: #fff; }
      .flag-icon { width: 20px; height: 15px; object-fit: cover; margin-right: 8px; border-radius: 2px; }
      .content-wrap { display:flex; flex-direction:column; height:100vh; overflow:hidden; }
      .content-scroll { flex:1; overflow-y:auto; }
      /* Remove overflow and padding for map page */
      main.content-wrap[data-active="mapa"] .content-scroll { overflow:hidden; padding:0 !important; }
      /* Mobile header button */
      .mobile-toggle { position: fixed; top: 14px; left: 14px; z-index: 1051; }
      /* Avoid toggle button overlapping page titles on small screens */
      @media (max-width: 991.98px) {
        /* For specific pages reserve space on their page titles so the fixed toggle doesn't overlap */
        main.content-wrap[data-active="mapa"] h2,
        main.content-wrap[data-active="favoritos"] h2,
        main.content-wrap[data-active="historial"] h2,
        main.content-wrap[data-active="perfil"] h2,
        main.content-wrap[data-active="rutas"] h2,
        main.content-wrap[data-active="config"] h2 {
          /* push the title down so the fixed toggle doesn't cover it */
          margin-left: 50px !important;
          padding-top: 0; /* avoid double spacing if h2 has padding */
        }
        /* Slightly adjust toggle to sit inside safe area */
        .mobile-toggle { top: 28px; left: 25px; }
      }
      /* Make offcanvas (mobile) nav links match desktop sidebar styles */
      .offcanvas .nav-link { color: var(--sidebar-text); border-radius: 10px; display: flex; align-items: center; width: 100%; box-sizing: border-box; padding-left: .75rem; padding-right: .75rem; }
      .offcanvas .nav-link .bi { width: 22px; text-align: center; margin-right: .75rem; flex: 0 0 22px; }
      .offcanvas .nav-link:hover { background: rgba(255,255,255,.06); color: #fff; }
      .offcanvas .nav-link.active { background: var(--brand-accent); color: #fff; }
    </style>
  </h:head>
  <h:body>

    <!-- Mobile toggle button -->
    <button class="btn btn-light d-lg-none mobile-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
      <i class="bi bi-list"></i>
    </button>

    <div class="d-flex layout-root">
      <!-- Sidebar (Desktop) -->
      <aside class="sidebar d-none d-lg-flex flex-column p-3 gap-3">
        <!-- Brand -->
        <div class="d-flex align-items-center gap-2 px-2 pt-1">
          <img class="align-items-center" src="#{facesContext.externalContext.requestContextPath}/img/icon_img.png" alt="Logo EnrouteAQP" style="width: 40px; height: 40px; object-fit: cover;" />
          <div class="brand-title">
            <div class="fw-bold text-white">Rutas</div>
            <div class="fw-bold text-white">Arequipa</div>
          </div>
        </div>

        <!-- Nav -->
        <nav class="mt-2">
          <ul class="nav nav-pills flex-column gap-2">
            <li class="nav-item">
              <h:link outcome="mapa" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'mapa' ? 'active' : ''}">
                <i class="bi bi-bus-front"></i>
                <span>#{msg['nav.viajar']}</span>
              </h:link>
            </li>
            <li class="nav-item">
              <h:panelGroup rendered="#{not empty sessionScope.userName}">
                <h:link outcome="/pages/favoritos.xhtml" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'favoritos' ? 'active' : ''}">
                  <i class="bi bi-heart"></i>
                  <span>#{msg['nav.favoritos']}</span>
                </h:link>
              </h:panelGroup>
              <h:panelGroup rendered="#{empty sessionScope.userName}">
                <a href="#" onclick="showLoginModal(); return false;" class="nav-link d-flex align-items-center px-3 py-2">
                  <i class="bi bi-heart"></i>
                  <span>#{msg['nav.favoritos']}</span>
                </a>
              </h:panelGroup>
            </li>
            <li class="nav-item">
              <h:panelGroup rendered="#{not empty sessionScope.userName}">
                <h:link outcome="/pages/historial.xhtml" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'historial' ? 'active' : ''}">
                  <i class="bi bi-clock-history"></i>
                  <span>#{msg['nav.historial']}</span>
                </h:link>
              </h:panelGroup>
              <h:panelGroup rendered="#{empty sessionScope.userName}">
                <a href="#" onclick="showLoginModal(); return false;" class="nav-link d-flex align-items-center px-3 py-2">
                  <i class="bi bi-clock-history"></i>
                  <span>#{msg['nav.historial']}</span>
                </a>
              </h:panelGroup>
            </li>
            <li class="nav-item">
              <h:link outcome="rutas" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'rutas' ? 'active' : ''}">
                <i class="bi bi-geo"></i>
                <span>#{msg['nav.rutas']}</span>
              </h:link>
            </li>
            <li class="nav-item">
              <h:panelGroup rendered="#{not empty sessionScope.userName}">
                <h:link outcome="perfil" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'perfil' ? 'active' : ''}">
                  <i class="bi bi-person-circle"></i>
                  <span>#{msg['nav.perfil']}</span>
                </h:link>
              </h:panelGroup>
              <h:panelGroup rendered="#{empty sessionScope.userName}">
                <a href="#" onclick="showLoginModal(); return false;" class="nav-link d-flex align-items-center px-3 py-2">
                  <i class="bi bi-person-circle"></i>
                  <span>#{msg['nav.perfil']}</span>
                </a>
              </h:panelGroup>
            </li>
            
            <!-- Admin-only links -->
            <li class="nav-item">
              <h:link outcome="usermng" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'usermng' ? 'active' : ''}"
                      rendered="#{not empty sessionScope.isAdmin and sessionScope.isAdmin}">
                <i class="bi bi-shield-lock"></i>
                <span>#{msg['nav.admin.users']}</span>
              </h:link>
            </li>
            <li class="nav-item">
              <h:link outcome="routesmng" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'routesmng' ? 'active' : ''}"
                      rendered="#{not empty sessionScope.isAdmin and sessionScope.isAdmin}">
                <i class="bi bi-shield-lock"></i>
                <span>#{msg['nav.admin.routes']}</span>
              </h:link>
            </li>
          </ul>
        </nav>

        <div class="mt-auto">
          <h:link outcome="configuracion" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'configuracion' ? 'active' : ''}">
                <i class="bi bi-gear"></i>
                <span>#{msg['nav.config']}</span>
          </h:link>
          
          <!-- Language Selector Dropdown -->
          <div class="dropdown language-dropdown mt-2">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="d-flex align-items-center">
                <h:panelGroup rendered="#{localeBean.language eq 'es'}">
                  <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-icon" />
                  <span>Español</span>
                </h:panelGroup>
                <h:panelGroup rendered="#{localeBean.language eq 'en'}">
                  <img src="https://flagcdn.com/w40/us.png" alt="English" class="flag-icon" />
                  <span>English</span>
                </h:panelGroup>
              </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="languageDropdown">
              <li>
                <h:form styleClass="m-0">
                  <h:commandLink action="#{localeBean.change('es')}" styleClass="dropdown-item d-flex align-items-center #{localeBean.language eq 'es' ? 'active' : ''}">
                    <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-icon" />
                    <span>Español</span>
                  </h:commandLink>
                </h:form>
              </li>
              <li>
                <h:form styleClass="m-0">
                  <h:commandLink action="#{localeBean.change('en')}" styleClass="dropdown-item d-flex align-items-center #{localeBean.language eq 'en' ? 'active' : ''}">
                    <img src="https://flagcdn.com/w40/us.png" alt="English" class="flag-icon" />
                    <span>English</span>
                  </h:commandLink>
                </h:form>
              </li>
            </ul>
          </div>
          
          <div class="d-flex align-items-center gap-2 mt-3 px-2 user-mini">
            <h:panelGroup rendered="#{not empty sessionScope.userName}">
              <div class="user-avatar">
                <h:outputText value="#{sessionScope.userName.substring(0,1)}" />
              </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{empty sessionScope.userName}">
              <div class="user-avatar">
                <i class="bi bi-person-fill"></i>
              </div>
            </h:panelGroup>
            <div class="flex-grow-1">
              <div class="fw-semibold">#{empty sessionScope.userName ? 'Invitado' : sessionScope.userName}</div>
              <h:form rendered="#{not empty sessionScope.userName}">
                  <h:commandButton value="#{msg['button.logout']}" action="#{logoutBean.logout}" styleClass="btn btn-sm btn-outline-light mt-2" />
              </h:form>            
            </div>            
          </div>
        </div>
      </aside>

      <!-- Offcanvas (Mobile) -->
      <div class="offcanvas offcanvas-start text-bg-dark d-lg-none" tabindex="-1" id="mobileSidebar">
        <div class="offcanvas-header justify-content-center position-relative">
            <div class="d-flex align-items-center">
              <img class="align-items-center" src="#{facesContext.externalContext.requestContextPath}/img/icon_img.png" alt="Logo EnrouteAQP" style="width: 40px; height: 40px; object-fit: cover;" />
              <h5 class="offcanvas-title ms-2 mb-0">#{msg['brand.title']}</h5>
            </div>
            <button type="button" class="btn-close btn-close-white position-absolute end-0 me-2" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
        <div class="offcanvas-body">
          <ul class="nav nav-pills flex-column gap-2">
            <li class="nav-item">
              <h:link outcome="mapa" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'mapa' ? 'active' : ''}">
                <i class="bi bi-bus-front"></i>
                <span>#{msg['nav.viajar']}</span>
              </h:link>
            </li>
            <li class="nav-item">
              <h:panelGroup rendered="#{not empty sessionScope.userName}">
                <h:link outcome="/pages/favoritos.xhtml" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'favoritos' ? 'active' : ''}">
                  <i class="bi bi-heart"></i>
                  <span>#{msg['nav.favoritos']}</span>
                </h:link>
              </h:panelGroup>
              <h:panelGroup rendered="#{empty sessionScope.userName}">
                <a href="#" onclick="showLoginModal(); return false;" class="nav-link d-flex align-items-center px-3 py-2">
                  <i class="bi bi-heart"></i>
                  <span>#{msg['nav.favoritos']}</span>
                </a>
              </h:panelGroup>
            </li>
            <li class="nav-item">
              <h:panelGroup rendered="#{not empty sessionScope.userName}">
                <h:link outcome="/pages/historial.xhtml" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'historial' ? 'active' : ''}">
                  <i class="bi bi-clock-history"></i>
                  <span>#{msg['nav.historial']}</span>
                </h:link>
              </h:panelGroup>
              <h:panelGroup rendered="#{empty sessionScope.userName}">
                <a href="#" onclick="showLoginModal(); return false;" class="nav-link d-flex align-items-center px-3 py-2">
                  <i class="bi bi-clock-history"></i>
                  <span>#{msg['nav.historial']}</span>
                </a>
              </h:panelGroup>
            </li>
            <li class="nav-item">
              <h:link outcome="rutas" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'rutas' ? 'active' : ''}">
                <i class="bi bi-geo"></i>
                <span>#{msg['nav.rutas']}</span>
              </h:link>
            </li>
            <li class="nav-item">
              <h:panelGroup rendered="#{not empty sessionScope.userName}">
                <h:link outcome="perfil" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'perfil' ? 'active' : ''}">
                  <i class="bi bi-person-circle"></i>
                  <span>#{msg['nav.perfil']}</span>
                </h:link>
              </h:panelGroup>
              <h:panelGroup rendered="#{empty sessionScope.userName}">
                <a href="#" onclick="showLoginModal(); return false;" class="nav-link d-flex align-items-center px-3 py-2">
                  <i class="bi bi-person-circle"></i>
                  <span>#{msg['nav.perfil']}</span>
                </a>
              </h:panelGroup>
            </li>
            <!-- Admin-only links (mobile) -->            
            <li class="nav-item">
              <h:link outcome="usermng" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'usermng' ? 'active' : ''}"
                      rendered="#{not empty sessionScope.isAdmin and sessionScope.isAdmin}">
                <i class="bi bi-shield-lock"></i>
                <span>Administrar Usuarios</span>
              </h:link>
            </li>
            <li class="nav-item">
              <h:link outcome="routesmng" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'routesmng' ? 'active' : ''}"
                      rendered="#{not empty sessionScope.isAdmin and sessionScope.isAdmin}">
                <i class="bi bi-shield-lock"></i>
                <span>#{msg['nav.admin.routes']}</span>
              </h:link>
            </li>
          </ul>
          <hr />
          <h:link outcome="configuracion" styleClass="nav-link d-flex align-items-center px-3 py-2 #{active eq 'configuracion' ? 'active' : ''}">
                <i class="bi bi-gear"></i>
                <span>#{msg['nav.config']}</span>
          </h:link>
          
          <!-- Language Selector Dropdown (Mobile) -->
          <div class="dropdown language-dropdown mt-2">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between" type="button" id="languageDropdownMobile" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="d-flex align-items-center">
                <h:panelGroup rendered="#{localeBean.language eq 'es'}">
                  <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-icon" />
                  <span>Español</span>
                </h:panelGroup>
                <h:panelGroup rendered="#{localeBean.language eq 'en'}">
                  <img src="https://flagcdn.com/w40/us.png" alt="English" class="flag-icon" />
                  <span>English</span>
                </h:panelGroup>
              </span>
            </button>
            <ul class="dropdown-menu w-100" aria-labelledby="languageDropdownMobile">
              <li>
                <h:form styleClass="m-0">
                  <h:commandLink action="#{localeBean.change('es')}" styleClass="dropdown-item d-flex align-items-center #{localeBean.language eq 'es' ? 'active' : ''}">
                    <img src="https://flagcdn.com/w40/es.png" alt="Español" class="flag-icon" />
                    <span>Español</span>
                  </h:commandLink>
                </h:form>
              </li>
              <li>
                <h:form styleClass="m-0">
                  <h:commandLink action="#{localeBean.change('en')}" styleClass="dropdown-item d-flex align-items-center #{localeBean.language eq 'en' ? 'active' : ''}">
                    <img src="https://flagcdn.com/w40/us.png" alt="English" class="flag-icon" />
                    <span>English</span>
                  </h:commandLink>
                </h:form>
              </li>
            </ul>
          </div>
          
          <div class="d-flex align-items-center gap-2 mt-3">
            <h:panelGroup rendered="#{not empty sessionScope.userName}">
              <div class="user-avatar">
                <h:outputText value="#{sessionScope.userName.substring(0,1)}" />
              </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{empty sessionScope.userName}">
              <div class="user-avatar">
                <i class="bi bi-person-fill"></i>
              </div>
            </h:panelGroup>
            <div class="flex-grow-1">
              <div class="fw-semibold text-white">#{empty sessionScope.userName ? 'Invitado' : sessionScope.userName}</div>
            </div>
          </div>
          <div class="mt-3">
              <h:form rendered="#{not empty sessionScope.userName}">
                  <h:commandButton value="#{msg['button.logout']}" action="#{logoutBean.logout}" styleClass="btn btn-sm btn-light w-100" />
              </h:form>
          </div>
        </div>
      </div>

      <!-- Right content area -->
      <main class="content-wrap flex-grow-1" data-active="#{empty active ? '' : active}">
        <div class="content-scroll p-3 p-lg-4">
          <ui:insert name="content">Contenido</ui:insert>
        </div>
      </main>
    </div>

    <!-- Modal de Invitación a Registrarse -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #DD6B20; color: white;">
            <h5 class="modal-title fw-bold" id="loginModalLabel">
              <i class="bi bi-lock-fill me-2"></i>Acceso Restringido
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center py-4">
            <i class="bi bi-person-check" style="font-size: 4rem; color: #DD6B20;"></i>
            <h4 class="mt-3 mb-3">¡Únete a Rutas Arequipa!</h4>
            <p class="text-muted mb-4">
              Para acceder a esta función necesitas tener una cuenta. 
              Regístrate ahora y disfruta de todas las funcionalidades de nuestra aplicación.
            </p>
            <ul class="list-unstyled text-start mb-4">
              <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Guarda tus rutas favoritas</li>
              <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Consulta tu historial de viajes</li>
              <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Personaliza tu perfil</li>
              <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>¡Y mucho más!</li>
            </ul>
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <a href="#{facesContext.externalContext.requestContextPath}/client/RegisterClient.xhtml" 
               class="btn text-white fw-bold" style="background-color: #DD6B20;">
              <i class="bi bi-person-plus me-2"></i>Registrarme Ahora
            </a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showLoginModal() {
        var modal = new bootstrap.Modal(document.getElementById('loginModal'));
        modal.show();
      }
    </script>
  </h:body>
</html>
